steps:
  - name: 'python:3.10'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      # Secret Manager에서 가져온 비밀을 파일로 저장
      gcloud secrets versions access latest --secret="service-account-key" > /workspace/service-account-key.json
      
      # 가상환경 생성 및 활성화
      python3 -m venv venv
      . venv/bin/activate
      
      # 필요한 패키지 설치
      pip install -r requirements.txt
      
      # 정적 파일 수집 및 마이그레이션
      python manage.py collectstatic --noinput
      python manage.py migrate

  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['app', 'deploy']

service_account: 535442247184-compute@developer.gserviceaccount.com

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_STANDARD'

# 이거 안돼면 gcp inline으로 작성하기
# E2_HIGHCPU_8: 이 머신 유형은 CPU 중심의 작업에 적합합니다.
# E2_STANDARD: 일반적인 컴퓨팅 작업에 적합합니다.
# E2_HIGHMEM: 메모리 중심의 작업에 적합합니다.
